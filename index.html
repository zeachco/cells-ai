<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cells - Simulation</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #222;
        }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            outline: none;
        }
    </style>
</head>
<body>
    <canvas id="glcanvas" tabindex='1'></canvas>
    <script src="https://not-fl3.github.io/miniquad-samples/gl.js"></script>
    <script type="module">
        // Add localStorage helper functions for Rust WASM
        window.storage_save = function(keyPtr, keyLen, valuePtr, valueLen) {
            try {
                const key = new TextDecoder().decode(
                    new Uint8Array(wasm_memory.buffer, keyPtr, keyLen)
                );
                const value = new TextDecoder().decode(
                    new Uint8Array(wasm_memory.buffer, valuePtr, valueLen)
                );
                localStorage.setItem(key, value);
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        };

        window.storage_load = function(keyPtr, keyLen, bufferPtr, bufferLen) {
            try {
                const key = new TextDecoder().decode(
                    new Uint8Array(wasm_memory.buffer, keyPtr, keyLen)
                );
                const value = localStorage.getItem(key);
                if (value === null) {
                    return 0;
                }
                const encoded = new TextEncoder().encode(value);
                const len = Math.min(encoded.length, bufferLen);
                const buffer = new Uint8Array(wasm_memory.buffer, bufferPtr, bufferLen);
                buffer.set(encoded.slice(0, len));
                return len;
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
                return 0;
            }
        };

        // Check for demo mode in URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const isDemoMode = urlParams.get('demo') === 'true';

        // Store demo mode flag to be read after WASM loads
        window.isDemoMode = isDemoMode;

        const wasmPath = import.meta.env.BASE_URL + 'cells.wasm';
        load(wasmPath).then(() => {
            if (typeof wasm_exports !== 'undefined' && wasm_exports.set_demo_mode) {
                wasm_exports.set_demo_mode(window.isDemoMode);
                console.log('Demo mode:', window.isDemoMode);
            }
        });
    </script>
</body>
</html>
